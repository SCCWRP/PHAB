---
output:
  html_document:
    keep_md: yes
    toc: no
    self_contained: no
---
# PHAB

#### *Marcus W. Beck, marcusb@sccwrp.org, Raphael D. Mazor, raphaelm@sccwrp.org, Andrew C. Rehn, andy.rehn@wildlife.ca.gov*

[![AppVeyor Build Status](https://ci.appveyor.com/api/projects/status/github/SCCWRP/PHAB?branch=master&svg=true)](https://ci.appveyor.com/project/SCCWRP/PHAB)
[![Travis-CI Build Status](https://travis-ci.org/SCCWRP/PHAB.svg?branch=master)](https://travis-ci.org/SCCWRP/PHAB)
[![DOI](https://zenodo.org/badge/108920024.svg)](https://zenodo.org/badge/latestdoi/108920024)

The PHAB package contains materials to calculate an index of physical integrity (IPI) for California streams. This index is estimated using site-specific data and available metrics of physical habitat to describe overall integrity.  

This tutorial assumes that the user is familiar with basic operations in the R programming language, such as data import, export, and manipulation. Although not required, we recommend using an integrated development environment for R, such as R-studio, which can be downloaded at [http://www.rstudio.com](http://www.rstudio.com). New users are encouraged to pursue training opportunities, such as those hosted by local R user groups. A list of such groups may be found here: http://blog.revolutionanalytics.com/local-r-groups.html. R training material developed by SCCWRP can also be found online: [https://sccwrp.github.io/SCCWRP_R_training/](https://sccwrp.github.io/SCCWRP_R_training/)

## Installation and basic usage

Install the package as follows:

```{r, eval = FALSE}
install.packages('devtools')
library(devtools)
install_github('SCCWRP/PHAB')
library(PHAB)
```

The core function is `IPI` that requires station and phab data as input.

```{r, echo = F, message = F, warning = F}
devtools::load_all()
```
```{r}
IPI(stations, phab)
```

# Detailed usage

The PHAB package can be installed from the R console with just a few lines of code.  The current version of the package can be found on SCCWRP's GitHub page [here](https://github.com/SCCWRP/PHAB) and can be installed using the devtools package.  The devtools package must be installed first before the PHAB package can be installed.  Start by installing and loading devtools:

```{r eval = F}
install.packages('devtools')
library(devtools)
```

Now the `install_github()` function from devtools can be used to install PHAB from GitHub.  The package can be loaded after installation.

```{r eval = F}
install_github('SCCWRP/PHAB')
library(PHAB)
```

The installation process may take a few seconds.  Both the devtools and PHAB packages depend on other R packages, all of which are installed together.  If an error is encountered during installation, an informative message is usually printed in the R console.  This information can help troubleshoot the problem, such as identifying which dependent packages may need to be installed separately.  Please contact SCCWRP staff if additional errors are encountered. 

After the package is successfully installed, you will be able to view the help file for the PHAB core function:

```{r, eval = F}
?IPI
```

## Preparing the input data

The `IPI()` function is used to calculate PHAB scores using both station and PHAB metric data as input. These data can be obtained from the state of California SWAMP reporting module.  Sample data are provided with the PHAB package to demonstrate the required format.  These data are loaded automatically once the package is installed and loaded.  You can view the `stations` and `phab` example data from the R console:

```{r}
head(stations)
head(phab)
```

The `stations` data includes site-specific information that are derived from geospatial analysis. These data are in wide format where one row corresponds to data for one site. The following fields are required:

* `StationCode` unique station identifier
* `MAX_ELEV` maximum elevation in the watershed in meters
* `AREA_SQKM` watershed area in square kilometers
* `MEANP_WS` mean phosphorus geology from the watershed
* `New_Long` site longitude, decimal degrees
* `SITE_ELEV` site elevation
* `KFCT_AVE` average soil erodibility factor
* `New_Lat` site latitude, decimal degrees
* `MINP_WS` minimum phosphorus geology from the watershed
* `PPT_00_09` average precipitation (2000 to 2009) at the sample point, in hundredths of millimeters

The `phab` data include estimated physical habitat metrics that are compiled along with the `stations` data to get the IPI score. These data are in long format where multiple rows correspond to physical habitat metric values for a single site.  The following fields are required: 

* `StationCode` unique station identifier
* `SampleDate` date of the sample
* `Variable` name of the PHAB metric
* `Result` resulting metric value
* `Count_Calc` number of unique observations that were used to estimate the value in `Result` 

Values in the `Variable` column of the `phab` data indicate which PHAB metric was measured that corresponds to values in the `Result` column.  The required PHAB metrics that should be provided for every site specified by `StationCode` are as follows:

* `XSLOPE` mean slope of reach
* `XBKF_W` mean bankfull width
* `H_AqHab` Shannon Diversity of aquatic chabitat types
* `PCT_SAFN` percent substrates smaller than sand (<2 mm)
* `XCMG` riparian cover sum of three layers
* `Ev_FlowHab` evenness of flow habitat types
* `H_SubNat` Shannon Diversity of natural substrate types
* `XC` mean upper canopy trees and saplings
* `PCT_POOL` percent pool of reach
* `XFC_ALG` mean filamentous algae cover
* `PCT_RC` percent concrete/asphalt

Each metric serves a specific purpose in the PHAB package.  The `H_AqHab`, `PCT_SAFN`, `XCMG`, `Ev_FlowHab`, and `H_SubNat` metrics are used to assess habitat condition.  The `XSLOPE`, `XBKF_W`, and `PCT_RC` metrics are used as predictors or score modifiers for different components of the IPI.  Finally, the `XC`, `PCT_POOL`, `XFC_ALG`, and `PCT_RC` metrics provide information that is used for quality assurance checks for select metrics and the overall IPI score.

All required fields for the `stations` and `phab` data are case-sensitive and must be spelled correctly.  The order of the fields does not matter.  All `StationCode` values must be shared between the datasets.  As described below, the `IPI()` function automatically checks the format of the input data prior to estimating scores.

## Using the IPI function

The `IPI()` function can be used on station and PHAB data that are correctly formatted as shown above.  The `stations` and `phab` example data are in the correct format and are loaded automatically with the PHAB package.  These data are used here to demonstrate use of the `IPI()` function.

```{r}
IPI(stations, phab)
```

A data frame of IPI scores estimated at each site on each unique sample date is returned.  The output data are in wide format with one row for each sample date at a site. Detailed information for each output column is as follows:

* `StationCode` unique station identifier 
* `SampleDate` date of the sample 
* `PHAB_SampleID` unique station identifier and sample date, used if more than one sample was collected at a station 
* `IPI` score for the index of physical integrity 
* `IPI_percentile` the percentile of the IPI score relative to all other stations
* `Ev_FlowHab` evenness of flow habitat types, from the raw PHAB metric
* `Ev_FlowHab_score` IPI score for evenness of flow habitat types
* `H_AqHab` Shannon Diversity of aquatic habitat types, from the raw PHAB metric
* `H_AqHab_pred` predicted Shannon Diversity of aquatic habitat types
* `H_AqHab_score` scored Shannon Diversity of aquatic habitat types
* `H_SubNat` Shannon Diversity of natural substrate types, from the raw PHAB metric
* `H_SubNat_score` scored Shannon Diversity of natural substrate types
* `PCT_SAFN` percent substrates smaller than sand (<2 mm), from the raw PHAB metric
* `PCT_RC` percent concrete/asphalt, from the raw PHAB metric
* `PCT_SAFN_pred` predicted percent substrates smaller than sand (<2 mm)
* `PCT_SAFN_score` scored percent substrates smaller than sand (<2 mm)
* `XCMG` riparian cover as sum of three layers, from the raw PHAB metric
* `XCMG_pred` predicted riparian cover as sum of three layers
* `XCMG_score` scored riparian cover as sum of three layers
* `IPI_qa` quality assurance for the IPI score
* `Ev_FlowHab_qa` quality assurance for evenness of flow habitat types
* `H_AqHab_qa` quality assurance for Shannon Diversity of aquatic habitat types
* `H_SubNat_qa` quality assurance for Shannon Diversity of natural substrate types
* `PCT_SAFN_qa` quality assurance for percent substrates smaller than sand (<2 mm)
* `XCMG_qa` quality assurance for riparian cover as sum of three layers

Metrics are included in the output as observed PHAB metrics, predicted metrics, and scored metrics.  The observed PHAB metrics are returned as is from the input data.  Some PHAB metrics include a predicted column that shows the modelled metric value based on the observed conditions at a site. Scored PHAB metrics are based on the difference between the observed and predicted scores for metrics with predictions, or estimated from the observed metric using an empirical formula for those without predicted values.  

The last five columns include quality assurance information for the IPI score and select metrics. QA values for metrics less than one indicate less quality assurance, usually resulting from less than the recommended locations being used at a sample site to assess a metric.  The QA value for the IPI is based on the lowest score among all metrics.  These columns are included by default and can be removed from the output by using the `qa = FALSE` argument.

```{r eval = F}
IPI(stations, phab, qa = FALSE)
```

## Interpreting IPI scores

Higher IPI scores returned by the `IPI()` function indicate physical habitat integrity at a station.  IPI scores > 1 represent locations with conditions similar to reference sites.  All metric scores are weighted equally to determine the overall IPI score.  The scored PHAB metrics vary from zero to one, with values closer to one indicating conditions that are likely to be observed with intact physical habitat.  For the observed PHAB metrics, all are expected to decrease under degraded physical conditions, except PCT_SAFN which is expected to increase. 

## Error checks for input data

The `IPI()` function will evaluate both the `stations` and `phab` input datasets for the correct format before estimating IPI scores.  The scores will not be calculated if any errors are encountered.  The following checks are made:

* No duplicate station codes in `stations`, i.e., one row per station
* All station codes in `stations` are in `phab` and the converse
* All required fields are present in `stations` and `phab`, see above
* All required PHAB metrics are present in the `variable` field of `phab` for each station and sample date
* No duplicate results for PHAB variables at each station and sample date
* All input variables for `stations` and `phab` are non-negative. The variables `XBKF_W`, `H_Aq_Hab`, `Ev_FlowHab`, and `H_SubNat` in `phab` must also be greater than zero.

The `IPI()` function will print informative messages to the R console if any of these errors are encountered.  It is the responsibility of the analyst to correct any errors in the raw data before proceeding.  

